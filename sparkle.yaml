// sparkle-script

// =======================================================================
// I. å…¨å±€å¼€å…³ä¸æ ¸å¿ƒé…ç½®
// =======================================================================

/**
 * @description å…¨å±€è„šæœ¬æ€»å¼€å…³
 * å¦‚æœè®¾ç½®ä¸º falseï¼Œæ•´ä¸ªè„šæœ¬å°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›åŸå§‹é…ç½®ã€‚
 */
const enable = true;

/**
 * @description æœåŠ¡ç­–ç•¥ç»„å¼€å…³
 * ç”¨äºæ§åˆ¶æ˜¯å¦ç”Ÿæˆç‰¹å®šæœåŠ¡çš„ç­–ç•¥ç»„å’Œç›¸å…³è§„åˆ™ã€‚
 * true: ç”Ÿæˆ | false: ä¸ç”Ÿæˆ
 * ä¾‹å¦‚ï¼Œå°† spotify è®¾ç½®ä¸º trueï¼Œè„šæœ¬å°±ä¼šè‡ªåŠ¨åˆ›å»º "Spotify" ç­–ç•¥ç»„å’ŒåŒ¹é… Spotify æµé‡çš„è§„åˆ™ã€‚
 */
const ruleOptions = {
    apple: true,      // è‹¹æœæœåŠ¡
    microsoft: true,  // å¾®è½¯æœåŠ¡
    google: true,     // GoogleæœåŠ¡
    openai: true,     // å›½å¤–AIå’ŒGPT
    spotify: false,   // Spotify
    youtube: true,    // YouTube
    bahamut: false,   // å·´å“ˆå§†ç‰¹/åŠ¨ç”»ç–¯
    netflix: false,   // Netflixç½‘é£
    tiktok: false,    // å›½é™…ç‰ˆæŠ–éŸ³
    disney: false,    // è¿ªå£«å°¼
    pixiv: false,     // Pixiv
    hbo: false,       // HBO
    biliintl: false,  // å“”å“©å“”å“©ä¸œå—äºš
    tvb: false,       // TVB
    hulu: false,      // Hulu
    primevideo: false,// äºšé©¬é€Šprime video
    telegram: true,   // Telegramé€šè®¯è½¯ä»¶
    line: false,      // Lineé€šè®¯è½¯ä»¶
    whatsapp: false,  // Whatsapp
    games: true,      // æ¸¸æˆç­–ç•¥ç»„
    japan: true,      // æ—¥æœ¬ç½‘ç«™ç­–ç•¥ç»„
    tracker: true,    // ç½‘ç»œåˆ†æå’Œè·Ÿè¸ªæœåŠ¡
    ads: true,        // å¸¸è§çš„ç½‘ç»œå¹¿å‘Š
    github: true,     // GitHub
};

/**
 * @description åŒºåŸŸèŠ‚ç‚¹è‡ªåŠ¨åˆ†ç»„é…ç½®
 * è„šæœ¬ä¼šæ ¹æ®è¿™é‡Œçš„é…ç½®ï¼Œè‡ªåŠ¨ç­›é€‰ä½ çš„ä»£ç†èŠ‚ç‚¹å¹¶åˆ›å»ºå¯¹åº”çš„ç­–ç•¥ç»„ã€‚
 */
const regionOptions = {
    // æ˜¯å¦æ’é™¤é«˜å€ç‡èŠ‚ç‚¹ï¼Œå½“å‰æœªåœ¨ä»£ç ä¸­ç›´æ¥ä½¿ç”¨ï¼Œä½†å¯ä½œä¸ºæœªæ¥æ‰©å±•çš„å¼€å…³
    excludeHighPercentage: true, 
    regions: [
        // name: æœ€ç»ˆç”Ÿæˆçš„ç­–ç•¥ç»„åç§°
        // regex: ç”¨äºåŒ¹é…èŠ‚ç‚¹åç§°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…åˆ°çš„èŠ‚ç‚¹ä¼šè¢«å½’å…¥æ­¤ç»„
        // ratioLimit: å€ç‡ä¸Šé™ï¼ŒèŠ‚ç‚¹åç§°ä¸­æå–å‡ºçš„å€ç‡é«˜äºæ­¤å€¼å°†è¢«å¿½ç•¥
        // icon: ç­–ç•¥ç»„çš„å›¾æ ‡URL
        { name: 'HKé¦™æ¸¯', regex: /æ¸¯|ğŸ‡­ğŸ‡°|hk|hongkong|hong kong/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hong_Kong.png' },
        { name: 'USç¾å›½', regex: /ç¾|ğŸ‡ºğŸ‡¸|us|united state|america/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_States.png' },
        { name: 'JPæ—¥æœ¬', regex: /æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|jp|japan/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Japan.png' },
        { name: 'KRéŸ©å›½', regex: /éŸ©|ğŸ‡°ğŸ‡·|kr|korea/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Korea.png' },
        { name: 'SGæ–°åŠ å¡', regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|sg|singapore/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Singapore.png' },
        { name: 'TWå°æ¹¾çœ', regex: /å°æ¹¾|ğŸ‡¹ğŸ‡¼|tw|taiwan|tai wan/i, ratioLimit: 2, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China.png' },
        // ... å…¶ä»–åŒºåŸŸ ...
    ],
};

/**
 * @description DNS æœåŠ¡å™¨é…ç½®
 */
const chinaDNS = ['119.29.29.29', '223.5.5.5'];
const foreignDNS = ['tls://8.8.8.8', 'tls://1.1.1.1', 'tls://9.9.9.9'];

/**
 * @description é€šç”¨æ¨¡æ¿é…ç½®
 * è¿™äº›æ˜¯åˆ›å»ºè§„åˆ™é›† (rule-provider) å’Œç­–ç•¥ç»„ (proxy-group) æ—¶å…±äº«çš„é»˜è®¤è®¾ç½®ã€‚
 */
// è§„åˆ™é›†é€šç”¨é…ç½®ï¼šç±»å‹ã€æ ¼å¼ã€è‡ªåŠ¨æ›´æ–°é—´éš”ï¼ˆ86400ç§’ = 24å°æ—¶ï¼‰
const ruleProviderCommon = { type: 'http', format: 'yaml', interval: 86400 };
// ä»£ç†ç»„é€šç”¨é…ç½®ï¼šå¥åº·æ£€æŸ¥é—´éš”ã€è¶…æ—¶ã€URLç­‰
const groupBaseOption = { interval: 300, timeout: 3000, url: 'http://cp.cloudflare.com/generate_204', lazy: true, 'max-failed-times': 3, hidden: false };

// =======================================================================
// II. æœåŠ¡å®šä¹‰ä¸­å¿ƒ (æ ¸å¿ƒ)
// =======================================================================
/**
 * @description è¿™æ˜¯æ•´ä¸ªè„šæœ¬çš„â€œå¤§è„‘â€å’Œâ€œè“å›¾â€ã€‚
 * æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å®šä¹‰äº†ä¸€ä¸ªâ€œæœåŠ¡â€ï¼ˆå¦‚YouTube, Googleç­‰ï¼‰ã€‚
 * è„šæœ¬ä¼šéå†è¿™ä¸ªæ•°ç»„ï¼Œæ ¹æ® `ruleOptions` çš„å¼€å…³çŠ¶æ€ï¼Œä¸ºæ¯ä¸ªå¯ç”¨çš„æœåŠ¡è‡ªåŠ¨ç”Ÿæˆè§„åˆ™å’Œç­–ç•¥ç»„ã€‚
 *
 * æ¯ä¸ªæœåŠ¡å¯¹è±¡çš„ç»“æ„:
 *   - key: å¿…é¡»ä¸ `ruleOptions` ä¸­çš„é”®åå®Œå…¨å¯¹åº”ï¼Œç”¨äºåˆ¤æ–­å¼€å…³çŠ¶æ€ã€‚
 *   - name: å°†è¦åˆ›å»ºçš„ç­–ç•¥ç»„çš„åç§°ï¼Œä¹Ÿæ˜¯è§„åˆ™ä¸­å¼•ç”¨çš„ç­–ç•¥ç›®æ ‡ã€‚
 *   - icon: ç­–ç•¥ç»„çš„å›¾æ ‡URLã€‚
 *   - url: (å¯é€‰) ç­–ç•¥ç»„çš„å¥åº·æ£€æŸ¥URLã€‚
 *   - rules: ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†åŒ¹é…æ­¤æœåŠ¡æµé‡çš„æ‰€æœ‰è§„åˆ™ã€‚
 *     - å¦‚æœè§„åˆ™ä¸åŒ…å«ç­–ç•¥ç»„ (å¦‚ 'GEOSITE,youtube')ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è¿½åŠ  `name` å­—æ®µä½œä¸ºå…¶ç­–ç•¥ç»„ã€‚
 *     - å¦‚æœè§„åˆ™å·²åŒ…å«ç­–ç•¥ç»„ (å¦‚ 'GEOSITE,microsoft@cn,å›½å†…ç½‘ç«™')ï¼Œåˆ™ä¿æŒä¸å˜ã€‚
 *   - providers: (å¯é€‰) å¦‚æœæœåŠ¡éœ€è¦é¢å¤–çš„ `rule-set`ï¼Œåœ¨è¿™é‡Œå®šä¹‰ã€‚
 *   - proxies: (å¯é€‰) è‡ªå®šä¹‰æ­¤æœåŠ¡ç­–ç•¥ç»„å†…çš„ä»£ç†åˆ—è¡¨ã€‚å¦‚æœæœªå®šä¹‰ï¼Œå°†ä½¿ç”¨ä¸‹é¢çš„ `defaultProxies`ã€‚
 */
const serviceDefinitions = [
    // åŸºç¡€æœåŠ¡
    { key: 'openai', name: 'å›½å¤–AI', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/ChatGPT.png', url: 'https://chat.openai.com/cdn-cgi/trace',
        rules: ['DOMAIN-SUFFIX,grazie.ai', 'DOMAIN-SUFFIX,grazie.aws.intellij.net', 'RULE-SET,ai', 'RULE-SET,category-ai-chat-excluded-cn'],
        providers: {
            'ai': { behavior: 'domain', format: 'mrs', url: 'https://fastly.jsdelivr.net/gh/DustinWin/ruleset_geodata@clash-ruleset/ai.mrs', path: './ruleset/DustinWin/ai.mrs' },
            'category-ai-chat-excluded-cn': { behavior: 'domain', format: 'mrs', url: 'https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/category-ai-chat-!cn.mrs', path: './ruleset/MetaCubeX/category-ai-chat-excluded-cn.mrs' }
        }
    },
    { key: 'youtube', name: 'YouTube', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/YouTube.png', url: 'https://www.youtube.com/s/desktop/494dd881/img/favicon.ico', rules: ['GEOSITE,youtube'] },
    { key: 'github', name: 'GitHub', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/GitHub.png', url: 'https://github.com/favicon.ico', rules: ['GEOSITE,github'] },
    { key: 'telegram', name: 'Telegram', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Telegram.png', url: 'http://www.telegram.org/img/website_icon.svg', rules: ['GEOIP,telegram'] },
    { key: 'apple', name: 'è‹¹æœæœåŠ¡', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Apple_2.png', url: 'http://www.apple.com/library/test/success.html', rules: ['GEOSITE,apple-cn'] },
    { key: 'google', name: 'è°·æ­ŒæœåŠ¡', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Google_Search.png', url: 'http://www.google.com/generate_204', rules: ['GEOSITE,google'] },
    { key: 'microsoft', name: 'å¾®è½¯æœåŠ¡', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Microsoft.png', url: 'http://www.msftconnecttest.com/connecttest.txt', rules: ['GEOSITE,microsoft@cn,å›½å†…ç½‘ç«™', 'GEOSITE,microsoft'] },
    // åŠŸèƒ½æ€§åˆ†ç»„
    { key: 'games', name: 'æ¸¸æˆä¸“ç”¨', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Game.png', rules: ['GEOSITE,category-games@cn,å›½å†…ç½‘ç«™', 'GEOSITE,category-games'] },
    { key: 'tracker', name: 'è·Ÿè¸ªåˆ†æ', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Reject.png', rules: ['GEOSITE,tracker'], proxies: ['REJECT', 'ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹'] },
    { key: 'ads', name: 'å¹¿å‘Šè¿‡æ»¤', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Advertising.png', rules: ['GEOSITE,category-ads-all'], proxies: ['REJECT', 'ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹'] },
    // ç‰¹æ®Šåœ°åŒº/ç½‘ç«™
    { key: 'japan', name: 'æ—¥æœ¬ç½‘ç«™', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/JP.png', url: 'https://r.r10s.jp/com/img/home/logo/touch.png',
        rules: ['RULE-SET,category-bank-jp', 'GEOIP,jp,æ—¥æœ¬ç½‘ç«™,no-resolve'],
        providers: {
            'category-bank-jp': { behavior: 'domain', format: 'mrs', url: 'https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/category-bank-jp.mrs', path: './ruleset/MetaCubeX/category-bank-jp.mrs' }
        }
    },
    // æµåª’ä½“æœåŠ¡
    { key: 'netflix', name: 'NETFLIX', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Netflix.png', url: 'https://api.fast.com/netflix/speedtest/v2?https=true', rules: ['GEOSITE,netflix'] },
    // ... å…¶ä»–æœåŠ¡å®šä¹‰ ...
];

// =======================================================================
// III. ä¸»é€»è¾‘å‡½æ•°
// =======================================================================
function main(config) {
    // å¦‚æœæ€»å¼€å…³å…³é—­ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    if (!enable) return config;

    // æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨ä»£ç†èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºé”™è¯¯
    const proxyCount = config?.proxies?.length ?? 0;
    if (proxyCount === 0) {
        throw new Error('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†èŠ‚ç‚¹');
    }

    // --- 1. æ ¸å¿ƒåŸºç¡€é…ç½®è¦†å†™ ---
    // è¿™éƒ¨åˆ†ä¼šå¼ºåˆ¶è¦†ç›–ä½ åŸå§‹é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®ï¼Œä»¥ç¡®ä¿è„šæœ¬ç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚
    config['allow-lan'] = true;       // å…è®¸å±€åŸŸç½‘è¿æ¥
    config['bind-address'] = '*';     // ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
    config['mode'] = 'rule';          // è§„åˆ™æ¨¡å¼
    config['profile'] = { 'store-selected': true, 'store-fake-ip': true }; // æŒä¹…åŒ–é€‰æ‹©å’Œfake-ip
    config['geodata-loader'] = 'memconservative'; // é€‚åˆå°å†…å­˜è®¾å¤‡çš„geodataåŠ è½½å™¨

    // DNS é…ç½®
    config['dns'] = {
        enable: true, listen: ':1053', ipv6: true,
        'enhanced-mode': 'fake-ip', 'fake-ip-range': '198.18.0.1/16',
        nameserver: [...foreignDNS],
        'proxy-server-nameserver': [...foreignDNS],
        'nameserver-policy': {
            'geosite:private': 'system', // ç§æœ‰åœ°å€å’ŒåŸŸåèµ°ç³»ç»ŸDNS
            'geosite:cn,apple@cn,microsoft@cn': chinaDNS, // å›½å†…ç›¸å…³åŸŸåèµ°å›½å†…DNS
        },
    };
    
    // ... å…¶ä»–æ ¸å¿ƒé…ç½®ï¼Œå¦‚sniffer, ntpç­‰ ...

    // --- 2. åŠ¨æ€ç”ŸæˆåŒºåŸŸç­–ç•¥ç»„ ---
    // éå† `regionOptions`ï¼Œæ ¹æ®æ­£åˆ™è¡¨è¾¾å¼ç­›é€‰èŠ‚ç‚¹ï¼Œåˆ›å»º url-test æµ‹é€Ÿç»„ã€‚
    let regionProxyGroups = [];
    let otherProxyGroups = config.proxies.map(p => p.name);

    regionOptions.regions.forEach(region => {
        const proxies = config.proxies
            .filter(p => {
                const multiplier = /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)/i.exec(p.name)?.[1];
                return p.name.match(region.regex) && parseFloat(multiplier || '0') <= region.ratioLimit;
            })
            .map(p => p.name);

        if (proxies.length > 0) {
            regionProxyGroups.push({
                ...groupBaseOption, name: region.name, type: 'url-test',
                tolerance: 50, icon: region.icon, proxies: proxies,
            });
            otherProxyGroups = otherProxyGroups.filter(name => !proxies.includes(name));
        }
    });
    const regionProxyGroupNames = regionProxyGroups.map(g => g.name);

    // --- 3. åˆå§‹åŒ–è§„åˆ™ã€Providers å’Œç­–ç•¥ç»„æ•°ç»„ ---
    const rules = ['PROCESS-NAME,SunloginClient,DIRECT', 'PROCESS-NAME,SunloginClient.exe,DIRECT'];
    const ruleProviders = new Map();
    let serviceProxyGroups = [];

    // --- 4. æ•°æ®é©±åŠ¨ï¼šç”ŸæˆæœåŠ¡ç­–ç•¥ç»„å’Œè§„åˆ™ ---
    // è¿™æ˜¯è„šæœ¬çš„æ ¸å¿ƒå¾ªç¯ï¼Œå®ƒå°† `serviceDefinitions` ä¸­çš„è“å›¾å˜ä¸ºç°å®ã€‚
    // [MODIFIED] ä¸ºæœåŠ¡ç»„çš„é»˜è®¤ä»£ç†åˆ—è¡¨æ·»åŠ  "å…¶ä»–èŠ‚ç‚¹"
    const defaultServiceProxies = ['é»˜è®¤èŠ‚ç‚¹', ...regionProxyGroupNames, ...(otherProxyGroups.length > 0 ? ['å…¶ä»–èŠ‚ç‚¹'] : []), 'ç›´è¿'];

    serviceDefinitions.forEach(service => {
        // æ£€æŸ¥æ­¤æœåŠ¡çš„å¼€å…³æ˜¯å¦åœ¨ `ruleOptions` ä¸­ä¸º true
        if (ruleOptions[service.key]) {
            // A. ç”Ÿæˆè§„åˆ™: éå†æœåŠ¡å®šä¹‰ä¸­çš„ rules æ•°ç»„
            service.rules.forEach(rule => {
                const parts = rule.split(',');
                // å¦‚æœè§„åˆ™æœ¬èº«ä¸å¸¦ç­–ç•¥ç»„ï¼ˆéƒ¨ä»¶å°‘äº3ä¸ªï¼‰ï¼Œåˆ™è‡ªåŠ¨æŠŠæœåŠ¡åä½œä¸ºç­–ç•¥ç»„åŠ ä¸Š
                const targetGroup = parts.length < 3 ? `,${service.name}` : '';
                rules.push(`${rule}${targetGroup}`);
            });

            // B. ç”Ÿæˆ Rule Providers: å¦‚æœæœ‰å®šä¹‰ï¼Œåˆ™æ·»åŠ 
            if (service.providers) {
                for (const [name, providerConfig] of Object.entries(service.providers)) {
                    ruleProviders.set(name, { ...ruleProviderCommon, ...providerConfig });
                }
            }
            
            // C. ç”Ÿæˆç­–ç•¥ç»„: åˆ›å»ºä¸€ä¸ª select ç­–ç•¥ç»„
            const group = { 
                ...groupBaseOption, 
                name: service.name, 
                type: 'select', 
                proxies: service.proxies || defaultServiceProxies // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ä»£ç†åˆ—è¡¨
            };
            if (service.url) group.url = service.url;
            if (service.icon) group.icon = service.icon;
            serviceProxyGroups.push(group);
        }
    });

    // --- 5. å®šä¹‰æ ¸å¿ƒåŠŸèƒ½ç­–ç•¥ç»„ ---
    // è¿™äº›æ˜¯ä¸å…·ä½“æœåŠ¡æ— å…³ï¼Œä½†å¯¹æ•´ä½“ä½“éªŒå¾ˆé‡è¦çš„ç­–ç•¥ç»„ã€‚
    const coreProxyGroups = [
        { ...groupBaseOption, name: 'ä¸‹è½½è½¯ä»¶', type: 'select', proxies: ['ç›´è¿', 'REJECT', 'é»˜è®¤èŠ‚ç‚¹', ...regionProxyGroupNames], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Download.png' },
        { ...groupBaseOption, name: 'å…¶ä»–å¤–ç½‘', type: 'select', proxies: ['é»˜è®¤èŠ‚ç‚¹', ...regionProxyGroupNames], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Streaming!CN.png' },
        { ...groupBaseOption, name: 'å›½å†…ç½‘ç«™', type: 'select', proxies: ['ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹', ...regionProxyGroupNames], url: 'http://wifi.vivo.com.cn/generate_204', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/StreamingCN.png' },
    ];
    
    // --- 6. å®šä¹‰ "é»˜è®¤èŠ‚ç‚¹" å’Œ "å…¶ä»–èŠ‚ç‚¹" ç­–ç•¥ç»„ ---
    const defaultProxyGroup = { ...groupBaseOption, name: 'é»˜è®¤èŠ‚ç‚¹', type: 'select', proxies: [...regionProxyGroupNames, ...(otherProxyGroups.length > 0 ? ['å…¶ä»–èŠ‚ç‚¹'] : []), 'ç›´è¿'], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Proxy.png' };
    
    let otherNodesGroup = null;
    if (otherProxyGroups.length > 0) {
        otherNodesGroup = { ...groupBaseOption, name: 'å…¶ä»–èŠ‚ç‚¹', type: 'select', proxies: otherProxyGroups, icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png' };
    }

    // --- 7. ç»„åˆæœ€ç»ˆçš„ç­–ç•¥ç»„åˆ—è¡¨ (æŒ‰è¦æ±‚æ’åº) ---
    // [MODIFIED] è°ƒæ•´ç­–ç•¥ç»„é¡ºåº
    config['proxy-groups'] = [
        defaultProxyGroup,      // 1. é»˜è®¤èŠ‚ç‚¹åœ¨å‰
        ...serviceProxyGroups,  // 2. æ‰€æœ‰æœåŠ¡ç»„å±…ä¸­
        ...coreProxyGroups,     // 3. æ ¸å¿ƒåŠŸèƒ½ç»„åœ¨å
        ...regionProxyGroups,   // 4. è‡ªåŠ¨ç”Ÿæˆçš„åŒºåŸŸç»„
        ...(otherNodesGroup ? [otherNodesGroup] : []) // 5. å…¶ä»–èŠ‚ç‚¹ç»„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    ];
    
    // --- 8. æ·»åŠ æœ€ç»ˆè§„åˆ™å’Œé™æ€Rule Provider ---
    // è¿™äº›è§„åˆ™æ˜¯è§„åˆ™åˆ—è¡¨çš„â€œå…œåº•â€è§„åˆ™ï¼Œå†³å®šäº†æœªè¢«å‰é¢æœåŠ¡è§„åˆ™åŒ¹é…åˆ°çš„æµé‡çš„å»å‘ã€‚
    rules.push(
        'RULE-SET,applications,ä¸‹è½½è½¯ä»¶',
        'GEOSITE,private,DIRECT',               // ç§æœ‰åœ°å€ç›´è¿
        'GEOIP,private,DIRECT,no-resolve',      // ç§æœ‰IPç›´è¿
        'GEOSITE,cn,å›½å†…ç½‘ç«™',                  // å›½å†…ç½‘ç«™èµ°â€œå›½å†…ç½‘ç«™â€ç­–ç•¥ç»„
        'GEOIP,cn,å›½å†…ç½‘ç«™,no-resolve',         // å›½å†…IPèµ°â€œå›½å†…ç½‘ç«™â€ç­–ç•¥ç»„
        'MATCH,å…¶ä»–å¤–ç½‘'                        // æ‰€æœ‰å…¶ä»–æœªåŒ¹é…çš„æµé‡ï¼Œèµ°â€œå…¶ä»–å¤–ç½‘â€ç­–ç•¥ç»„
    );
    ruleProviders.set('applications', { ...ruleProviderCommon, behavior: 'classical', format: 'text', url: 'https://fastly.jsdelivr.net/gh/DustinWin/ruleset_geodata@clash-ruleset/applications.list', path: './ruleset/DustinWin/applications.list' });

    // --- 9. æœ€ç»ˆæ•´åˆå¹¶è¿”å›é…ç½® ---
    config.proxies.push({ name: 'ç›´è¿', type: 'direct', udp: true }); // ç¡®ä¿æœ‰ç›´è¿èŠ‚ç‚¹
    config['rules'] = rules;
    config['rule-providers'] = Object.fromEntries(ruleProviders);

    return config;
}
